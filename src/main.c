#include <stddef.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>

#include "common.inc"

//////////////////////////////////////////////////////////////////////////////
// describe
//////////////////////////////////////////////////////////////////////////////

void describe(ae_obj_t * this, bool dotted) {
  static unsigned int indent = 0;

  char buff[128] = { 0 };
  
  int written = 0;

  while (written++ < ((int)(indent - (dotted ? 2 : 0)))) SPC;

  if (dotted)
    written += PR("â€¢ "); 
  
  written += PR("%018p", this);
  
  while (written++ < 32) SPC;

// This hacky extra print is required because we printed a multi-byte character earlier:
  if (dotted)
    written += PR("  ");
  
  written += PUT(this);
  
  while (written++ < 105) SPC;

// PUT_words(this);

  NL;
  
  if (CONSP(this)) {
    indent += 2;
    FOR_EACH(elem, this) {
      describe(elem, false);
      if (! TAILP(CDR(position)))
        describe(CDR(position), true);
    }
    indent -= 2;
  }
}

//////////////////////////////////////////////////////////////////////////////
// do_write
//////////////////////////////////////////////////////////////////////////////

void do_write(ae_obj_t * this) {
  ae_write(this);
  NL;
}

//////////////////////////////////////////////////////////////////////////////
// main
//////////////////////////////////////////////////////////////////////////////

int main(int argc, char **argv) {
#ifdef AE_PREFACE
  preface();
#endif
  
//////////////////////////////////////////////////////////////////////////////////////////////////
// set up the free list and populate the root env
//////////////////////////////////////////////////////////////////////////////////////////////////
  
  free_list_add_block(&mem[0], free_list_size);
  
  /* PR("\nPopulating root env..."); */
  /* INDENT; */
  ae_obj_t * root_env = ENV_NEW_ROOT();
  /* OUTDENT; */
  /* LOG(root_env, "Done populating"); */

  /* PR("\n\nroot_env is at:    %08p.\n", root_env); */

//////////////////////////////////////////////////////////////////////////////////////////////////
#ifdef AE_PAINT_EARLY_OBJECTS
//////////////////////////////////////////////////////////////////////////////////////////////////

//////////////////////////////////////////////////////////////////////////////////////////////////
// set up the read_origin and promordial_origin objects
//////////////////////////////////////////////////////////////////////////////////////////////////
 
  NL;
  
  ae_obj_t * primordial_origin = NIL;
  KSET(primordial_origin, KW("origin"), KW("primordial"));
  
  ae_obj_t * read_origin = NIL;
  KSET(read_origin, KW("origin"), KW("read"));

//////////////////////////////////////////////////////////////////////////////////////////////////
// paint the objects populating the root env with origin = primordial
//////////////////////////////////////////////////////////////////////////////////////////////////

  PR("Painting objects populating the root env with origin = primordial...");
  NL;
  
  for (int ix = 0; ix < AE_OBJ_POOL_SIZE; ix++)
    if (! FREEP(pool_get_object(ix))) {
#ifdef AE_LOG_KVP_SET_GET
      //LOG(pool_get_object(ix), "#%d: Setting origin to 'primordial'", ix);
#endif
      
#ifdef AE_DEBUG_OBJ
      DOBJ(pool_get_object(ix)) = primordial_origin;
#endif
    }

  PR("Done painting objects populating the root env with origin = primordial.");
  NL;
  
//////////////////////////////////////////////////////////////////////////////////////////////////
#endif
//////////////////////////////////////////////////////////////////////////////////////////////////

//////////////////////////////////////////////////////////////////////////////////////////////////
// read and parse file
//////////////////////////////////////////////////////////////////////////////////////////////////

  FILE * fp = fopen("data/sample.lisp", "r");
  yyin = fp;
  yyparse();
  fclose(fp);  

//////////////////////////////////////////////////////////////////////////////////////////////////
#ifdef AE_PAINT_EARLY_OBJECTS
//////////////////////////////////////////////////////////////////////////////////////////////////

//////////////////////////////////////////////////////////////////////////////////////////////////
// paint the objects read from file with origin = read
//////////////////////////////////////////////////////////////////////////////////////////////////

  // pool_print();

  PR("Painting objects read from file with origin = read...");
  NL;
    
  for (int ix = 0; ix < AE_OBJ_POOL_SIZE; ix++)
    if (! FREEP(pool_get_object(ix)) && ! DHAS(pool_get_object(ix), "origin")) {
#ifdef AE_LOG_KVP_SET_GET
      //  LOG(pool_get_object(ix), "#%d: Setting origin to 'read'", ix);
#endif
      
#ifdef AE_DEBUG_OBJ
      DOBJ(pool_get_object(ix)) = read_origin;
#endif
    }

  PR("Done painting objects read from file with origin = read.");
  NL;
  
//////////////////////////////////////////////////////////////////////////////////////////////////
#endif
//////////////////////////////////////////////////////////////////////////////////////////////////
  
//////////////////////////////////////////////////////////////////////////////////////////////////
// dump the pool, eval the program, dump the pool again
//////////////////////////////////////////////////////////////////////////////////////////////////  

#ifdef AE_DUMP_POOL_BEFORE
  pool_print();
#endif

  /* puts("Writing program obj."); */
  /* WRITE(program); */
  /* NL; */
  /* puts("Wrote program obj."); */
  /* NL; */
  
  /* SLOG("Evaluating program..."); */
  EVAL(root_env, program);
  /* SLOG("\nDone evaluating program.\n"); */
  
#ifdef AE_DUMP_POOL_AFTER
  pool_print();
#endif

#ifdef AE_DUMP_SYMS
  PR("syms: "); WRITE(ENV_SYMS(root_env)); NL;
#endif

#ifdef AE_DUMP_VALS
  PR("vals: "); WRITE(ENV_VALS(root_env)); NL;
#endif
}

//////////////////////////////////////////////////////////////////////////////////////////////////  
// End of main
//////////////////////////////////////////////////////////////////////////////////////////////////  
