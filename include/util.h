#pragma once

////////////////////////////////////////////////////////////////////////////////////////////////////
// Helper for avoiding double evaluation of macro parameters
////////////////////////////////////////////////////////////////////////////////////////////////////
#define CAPTURE(o)                       ae_obj_t * tmp_##__LINE__ = (o)
#define CAPTURED                         tmp_##__LINE__
////////////////////////////////////////////////////////////////////////////////////////////////////


////////////////////////////////////////////////////////////////////////////////////////////////////
// jump-return and error bailing
////////////////////////////////////////////////////////////////////////////////////////////////////
#define BAIL_IF_ERRORP(obj)                                                                        \
  ({                                                                                               \
    CAPTURE(obj);                                                                                  \
    if (ERRORP(CAPTURED)) {                                                                        \
      ret = CAPTURED;                                                                              \
      goto end;                                                                                    \
    }                                                                                              \
    CAPTURED;                                                                                      \
  })
////////////////////////////////////////////////////////////////////////////////////////////////////
#define RETURN(obj)                                                                                \
  ({                                                                                               \
    CAPTURE(obj);                                                                                  \
    ret = CAPTURED;                                                                                \
    goto end;                                                                                      \
  })
////////////////////////////////////////////////////////////////////////////////////////////////////
#define RETURN_NIL_IF_NILP(obj)                                                                    \
  if (NILP((obj))) RETURN(NIL)
////////////////////////////////////////////////////////////////////////////////////////////////////
#define OUTDENT_AND_BAIL_IF_ERRORP(obj)                                                            \
  ({ OUTDENT; BAIL_IF_ERRORP((ob)); })
////////////////////////////////////////////////////////////////////////////////////////////////////
#define OUTDENT_AND_RETURN_NIL_IF_NILP(obj)                                                        \
  ({ OUTDENT; RETURN_NIL_IF_NILP((ob)); })
////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////
#define DOUBLE_OUTDENT_AND_RETURN_NIL_IF_NILP(obj)                                                 \
  ({ OUTDENT; OUTDENT; RETURN_NIL_IF_NILP((ob)); })
////////////////////////////////////////////////////////////////////////////////////////////////////
